CREATE TABLE IF NOT EXISTS CUSTOMER_SALES_FACT
(
    Customer_ID      VARCHAR(20) 
  , Product_SKU_ID   VARCHAR(250)
  , Order_Date       DATE
  , Order_value      VARCHAR(250)
  , Order_id         VARCHAR(100)
  , Order_Month   VARCHAR(250)
);

CREATE TABLE IF NOT EXISTS PRODUCT
(
    Product_SKU_ID      VARCHAR(20) 
  , Product_SKU_Name    VARCHAR(250)
  , Product_Brand       VARCHAR(100)
  , Market_Name      VARCHAR(100)
);

CREATE TABLE IF NOT EXISTS EMPLOYEE
(
    Employee_ID      VARCHAR(20) 
  , Employee_Name    VARCHAR(250)
  , Employee_City    VARCHAR(100)
  , Employee_DOB     DATE
  , Employee_Pin_Code VARCHAR(100)
  , Salary      INT
);

CREATE TABLE IF NOT EXISTS MAP_EMPLOYEE_HIERARCHY
(
    Employee_ID      VARCHAR(20) 
  , Manager_Employee_ID  VARCHAR(250)
);
ALTER TABLE Employee ALTER COLUMN Salary TYPE integer USING (Salary::integer);

INSERT INTO EMPLOYEE VALUES
        ('EMP1','Sarah','Phoenix',TO_DATE('1982-11-12', 'YYYY-MM-DD'), '85027',150000),
  ('EMP2','Mellisa','LA',TO_DATE('1980-04-24', 'YYYY-MM-DD'), '85027',200000),
  ('EMP3','John','Boston',TO_DATE('1986-02-18', 'YYYY-MM-DD'), '85027',180000),
  ('EMP4','Gary','NewMexico',TO_DATE('1975-02-12', 'YYYY-MM-DD'), '87121',170000),
  ('EMP5','Tony','SFO',TO_DATE('1960-01-08', 'YYYY-MM-DD'), '94016',300000),
  ('EMP6','Jason','Utah',TO_DATE('1972-05-25', 'YYYY-MM-DD'), '84118',110000),
     ('EMP7','Adam','Boston',TO_DATE('1970-02-18', 'YYYY-MM-DD'), '85027',250000),
  ('EMP8','Terry','NewMexico',TO_DATE('1980-02-12', 'YYYY-MM-DD'), '87121',300000),
  ('EMP9','Phil','SFO',TO_DATE('1978-01-08', 'YYYY-MM-DD'), '94016',270000),
  ('EMP10','David','Utah',TO_DATE('1980-05-25', 'YYYY-MM-DD'), '84118',280000);

INSERT INTO MAP_EMPLOYEE_HIERARCHY VALUES
        ('EMP1','EMP4'),
  ('EMP2','EMP5'),
  ('EMP3','EMP5'),
  ('EMP6','EMP4'),
        ('EMP4','EMP7'),
  ('EMP5','EMP8'),
  ('EMP8','EMP9'),
  ('EMP9','EMP10'),
  ('EMP10', NULL);


  
INSERT INTO Customer_Sales_Fact VALUES
        ('CUSTOMER1','TSHIRT',TO_DATE('2021-11-24', 'YYYY-MM-DD'), '54', 'ORDER1','NOV'),
  ('CUSTOMER2','JEANS',TO_DATE('2021-12-08', 'YYYY-MM-DD'), '100', 'ORDER2','DEC'),
     ('CUSTOMER3','SHOES',TO_DATE('2022-01-24', 'YYYY-MM-DD'), '150', 'ORDER3','JAN'),
     ('CUSTOMER1','BELT',TO_DATE('2021-06-07', 'YYYY-MM-DD'), '20', 'ORDER4','JUNE'),
     ('CUSTOMER2','TOWEL',TO_DATE('2022-01-18', 'YYYY-MM-DD'), '5', 'ORDER5','JAN'), 
  ('CUSTOMER2','TSHIRT',TO_DATE('2021-05-22', 'YYYY-MM-DD'), '40', 'ORDER6','OCT');

  
INSERT INTO PRODUCT VALUES
        ('TSHIRT','WHITETSHIRTS','NIKE','USWEST'), 
  ('JEANS','BLUEJEANS','LEVI','USWEST'), 
  ('SHOES','FORMALSHOES','CK','USEAST'), 
  ('BELT','BROWNBELTS','TOMMY','USMIDWEST'), 
  ('TOWEL','BATHTOWELS','COSTCO','US'),
        ('Jewelery','Diamond','SIGNET','USMIDWEST'), 
  ('Apparel','Rings','Kohls','USEAST');  

SELECT * FROM PRODUCT
SELECT * FROM CUSTOMER_SALES_FACT

SELECT * FROM EMPLOYEE
SELECT * FROM MAP_EMPLOYEE_HIERARCHY

--Write a Query to list the Product Names(skus) that did not have any sales

SELECT 
	P.PRODUCT_SKU_NAME
	FROM PRODUCT P LEFT OUTER JOIN CUSTOMER_SALES_FACT CSF
	ON P.PRODUCT_SKU_ID = CSF.PRODUCT_SKU_ID
	WHERE CSF.PRODUCT_SKU_ID IS NULL;

--Write a Query to List the Managers whose  salary less then twice the Average salary of employees reporting to them


--MANAGER SALARY CALCULATION

WITH MANAGER_TBL AS (
SELECT 
	DISTINCT MEH.MANAGER_EMPLOYEE_ID AS MANAGER_EMP_ID,
	E.SALARY AS MANAGER_SALARY
	FROM EMPLOYEE E INNER JOIN MAP_EMPLOYEE_HIERARCHY MEH
	ON E.EMPLOYEE_ID = MEH.MANAGER_EMPLOYEE_ID),
--EMPLOYEE SALARY CALCULATION
EMPLOYEE_TBL AS (
SELECT 
	DISTINCT MEH.MANAGER_EMPLOYEE_ID AS MANAGER_EMP_ID,
	2* AVG(E.SALARY) AS AVG_EMP_SALARY
	FROM EMPLOYEE E INNER JOIN MAP_EMPLOYEE_HIERARCHY MEH 
	ON E.EMPLOYEE_ID = MEH.EMPLOYEE_ID
	GROUP BY MEH.MANAGER_EMPLOYEE_ID)
-- COMPARISON
	SELECT MANAGER_TBL.MANAGER_EMP_ID 
	FROM MANAGER_TBL INNER JOIN EMPLOYEE_TBL 
	ON MANAGER_TBL.MANAGER_EMP_ID = EMPLOYEE_TBL.MANAGER_EMP_ID
	WHERE MANAGER_TBL.MANAGER_SALARY < EMPLOYEE_TBL.AVG_EMP_SALARY;
